version: '3'
services:
    carla-server:
        runtime: nvidia
        image: robocomp/carla_melex:latest
#        entrypoint: ./CarlaUE4.sh -carla-world-port=2000 -ResX=800 -ResY=600 -nosound -windowed
#        entrypoint: sh -c "chmod +x ./CarlaUE4/Binaries/Linux/CarlaUE4-Linux-Shipping.debug && ./CarlaUE4/Binaries/Linux/CarlaUE4-Linux-Shipping CarlaUE4 " #-carla-world-port=2000 -ResX=800 -ResY=600    -windowed
        entrypoint: bash ./CarlaUE4.sh -carla-world-port=2000 -ResX=800 -ResY=600 -nosound -windowed
        environment:
            - SDL_VIDEODRIVER=offscreen
            - SDL_HINT_CUDA_DEVICE=0
            - NVIDIA_VISIBLE_DEVICES=0
        volumes:
            - /tmp/.X11-unix:/tmp/.X11-unix
        expose:
            - 2000-2002

    carlaBridge:
        image: robocomp/robocomp:focal-melex
        entrypoint:  sh -c "sleep 5 && echo $PATH && cd carlaBridge && cmake . && make && (./src/carlaBridge.py)" #nc -vz carla-server 2000 #
        restart: always
        environment:
            - PATH=$PATH
            - NVIDIA_VISIBLE_DEVICES=all
            - NVIDIA_DRIVER_CAPABILITIES=graphics,utility,compute.
        volumes:
            - /home/robolab/robocomp/components/melex-rodao/:/home/robolab/robocomp/components/melex-rodao/
            - ./etc/carlaBridge/:/home/robolab/robocomp/components/melex-rodao/components/carlaBridge/etc/
        depends_on:
            - rcnode
            - carla-server
        healthcheck:
          test: [ "CMD", "curl", "-f", "http://carla-server:2000" ]
          interval: 30s
          timeout: 10s
          retries: 5

    carlaMonitor:
      image: robocomp/robocomp:focal-melex
      runtime: nvidia
      entrypoint: sh -c "sleep 12 && echo $PATH && cd carlaMonitor && cmake . && make && (./src/carlaMonitor.py etc/config)" #nc -vz carla-server 2000 #
      restart: always
      environment:
        - DISPLAY=$DISPLAY
        - PATH=$PATH
        - QT_X11_NO_MITSHM=1
        - NVIDIA_VISIBLE_DEVICES=all
      volumes:
        - /tmp/.X11-unix:/tmp/.X11-unix
        - /home/robolab/robocomp/components/melex-rodao/:/home/robolab/robocomp/components/melex-rodao/
        - ./etc/carlaMonitor/:/home/robolab/robocomp/components/melex-rodao/components/carlaMonitor/etc/
      depends_on:
        - rcnode
        - carla-server
        - carlaBridge
      healthcheck:
        test: [ "CMD", "curl", "-f", "http://carlaBridge:18111" ]
        interval: 30s
        timeout: 10s
        retries: 5


    carlaControl:
      image: robocomp/robocomp:focal-melex
      runtime: nvidia
      entrypoint: sh -c "sleep 10 && echo $PATH && cd carlaRemoteControl && cmake . && make && (./src/carlaRemoteControl.py etc/config)" #nc -vz carla-server 2000 #
      restart: always
      environment:
        - DISPLAY=$DISPLAY
        - PATH=$PATH
        - QT_X11_NO_MITSHM=1
        - NVIDIA_VISIBLE_DEVICES=all
      volumes:
        - /tmp/.X11-unix:/tmp/.X11-unix
        - /home/robolab/robocomp/components/melex-rodao/:/home/robolab/robocomp/components/melex-rodao/
        - ./etc/carlaRemoteControl/:/home/robolab/robocomp/components/melex-rodao/components/carlaRemoteControl/etc/
      depends_on:
        - carlaMonitor
      devices:
        - /dev/input/js0:/dev/input/js0


    rcnode:
        image: robocomp/robocomp:focal_dsr
        entrypoint: sh -c "rcnode"
        expose:
            - 9999
            - 9998
            
